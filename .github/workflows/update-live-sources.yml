name: Update Live TV Sources with Blacklist

on:
  schedule:
    - cron: '0 18 * * *'  # æ¯å¤©UTC 18:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ï¼‰
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'sources.txt'
      - 'blacklist.txt'
      - 'whitelist.txt'
      - 'config.txt'
      - '.github/workflows/update-live-sources.yml'
      - 'scripts/collect_sources.py'

permissions:
  contents: write

jobs:
  collect-and-organize:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Create necessary directories
      run: |
        mkdir -p scripts
        mkdir -p categories
        mkdir -p merged

    - name: Copy Python script to scripts directory
      run: |
        # å¦‚æœè„šæœ¬ä¸åœ¨scriptsç›®å½•ï¼Œåˆ›å»ºå®ƒ
        if [ -f collect_sources.py ]; then
          cp collect_sources.py scripts/collect_sources.py
          echo "âœ… å¤åˆ¶collect_sources.pyåˆ°scriptsç›®å½•"
        fi

    - name: Create config.txt if not exists
      run: |
        if [ ! -f config.txt ]; then
          echo "# ç”µè§†ç›´æ’­æºæ”¶é›†è„šæœ¬é…ç½®æ–‡ä»¶" > config.txt
          echo "# é…ç½®è¯´æ˜ï¼š" >> config.txt
          echo "# ENABLE_BLACKLIST: æ˜¯å¦å¯ç”¨é»‘åå•åŠŸèƒ½ (true/false)" >> config.txt
          echo "# ENABLE_WHITELIST: æ˜¯å¦å¯ç”¨ç™½åå•åŠŸèƒ½ (true/false)" >> config.txt
          echo "# ENABLE_SPEED_TEST: æ˜¯å¦å¯ç”¨æµ‹é€ŸåŠŸèƒ½ (true/false)" >> config.txt
          echo "# CONNECT_TIMEOUT: è¿æ¥è¶…æ—¶æ—¶é—´(ç§’)" >> config.txt
          echo "# STREAM_TIMEOUT: æµåª’ä½“æµ‹è¯•è¶…æ—¶æ—¶é—´(ç§’)" >> config.txt
          echo "# MIN_SPEED_SCORE: æœ€ä½é€Ÿåº¦è¯„åˆ†(0-1)" >> config.txt
          echo "# MAX_WORKERS: å¹¶å‘æµ‹è¯•çº¿ç¨‹æ•°" >> config.txt
          echo "" >> config.txt
          echo "# åŠŸèƒ½å¼€å…³" >> config.txt
          echo "ENABLE_BLACKLIST=true" >> config.txt
          echo "ENABLE_WHITELIST=true" >> config.txt
          echo "ENABLE_SPEED_TEST=false" >> config.txt
          echo "" >> config.txt
          echo "# è¶…æ—¶è®¾ç½®" >> config.txt
          echo "CONNECT_TIMEOUT=5" >> config.txt
          echo "STREAM_TIMEOUT=10" >> config.txt
          echo "" >> config.txt
          echo "# è¯„åˆ†é˜ˆå€¼" >> config.txt
          echo "MIN_SPEED_SCORE=0.5" >> config.txt
          echo "" >> config.txt
          echo "# å¹¶å‘è®¾ç½®" >> config.txt
          echo "MAX_WORKERS=20" >> config.txt
          echo "" >> config.txt
          echo "# ç™½åå•è®¾ç½®ï¼ˆä¼˜å…ˆçº§é«˜äºé»‘åå•ï¼‰" >> config.txt
          echo "# WHITELIST_FILE: ç™½åå•æ–‡ä»¶è·¯å¾„" >> config.txt
          echo "# WHITELIST_OVERRIDE_BLACKLIST: ç™½åå•æ˜¯å¦è¦†ç›–é»‘åå• (true/false)" >> config.txt
          echo "# WHITELIST_IGNORE_SPEED_TEST: ç™½åå•æ˜¯å¦å¿½ç•¥é€Ÿåº¦æµ‹è¯• (true/false)" >> config.txt
          echo "WHITELIST_FILE=whitelist.txt" >> config.txt
          echo "WHITELIST_OVERRIDE_BLACKLIST=true" >> config.txt
          echo "WHITELIST_IGNORE_SPEED_TEST=true" >> config.txt
          echo "âœ… åˆ›å»ºäº†config.txté…ç½®æ–‡ä»¶"
        fi

    - name: Create sources.txt if not exists
      run: |
        if [ ! -f sources.txt ]; then
          echo "# ç”µè§†ç›´æ’­æºåˆ—è¡¨" > sources.txt
          echo "# æ¯è¡Œä¸€ä¸ªM3Uæ–‡ä»¶URL" >> sources.txt
          echo "# è¯·æ·»åŠ å¯ç”¨çš„ç›´æ’­æºåœ°å€" >> sources.txt
          echo "" >> sources.txt
          echo "# ç¤ºä¾‹ç›´æ’­æºï¼š" >> sources.txt
          echo "# https://raw.githubusercontent.com/iptv-org/iptv/master/index.m3u" >> sources.txt
          echo "# https://raw.githubusercontent.com/EvilCult/iptv-mirror/master/IPTV.m3u" >> sources.txt
          echo "# https://raw.githubusercontent.com/YanG-1989/m3u/main/Gather.m3u" >> sources.txt
          echo "" >> sources.txt
          echo "# æ³¨æ„ï¼šè¯·ç§»é™¤åŸæœ‰çš„ä»¥ä¸‹ä¸¤ä¸ªæºï¼š" >> sources.txt
          echo "# https://raw.githubusercontent.com/fanmingming/live/main/tv/m3u/ipv6.m3u" >> sources.txt
          echo "# https://raw.githubusercontent.com/chao921125/source/refs/heads/main/iptv/index.m3u" >> sources.txt
          echo "" >> sources.txt
          echo "âœ… åˆ›å»ºäº†sources.txtæ–‡ä»¶ï¼Œè¯·ç¼–è¾‘æ·»åŠ ç›´æ’­æº"
        fi

    - name: Create blacklist.txt if not exists
      run: |
        if [ ! -f blacklist.txt ]; then
          echo "# ç›´æ’­æºé»‘åå•" > blacklist.txt
          echo "# è¯¥æ–‡ä»¶åŒ…å«å“åº”æ—¶é—´è¶…è¿‡6ç§’çš„æ…¢é€Ÿç›´æ’­æº" >> blacklist.txt
          echo "# æ¯è¡Œä¸€ä¸ªURLï¼Œä¸‹æ¬¡æ›´æ–°æ—¶ä¼šè·³è¿‡è¿™äº›æº" >> blacklist.txt
          echo "# ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> blacklist.txt
          echo "" >> blacklist.txt
          echo "# æ…¢é€ŸHTTPæº" >> blacklist.txt
          echo "# http://example.com/slow-stream.m3u8" >> blacklist.txt
          echo "" >> blacklist.txt
          echo "âœ… åˆ›å»ºäº†blacklist.txtæ–‡ä»¶"
        fi

    - name: Create whitelist.txt if not exists
      run: |
        if [ ! -f whitelist.txt ]; then
          echo "# ç›´æ’­æºç™½åå•" > whitelist.txt
          echo "# è¯¥æ–‡ä»¶åŒ…å«æ°¸ä¸åˆ é™¤çš„ç›´æ’­æº" >> whitelist.txt
          echo "# æ”¯æŒæ ¼å¼:" >> whitelist.txt
          echo "# 1. å®Œæ•´URL: https://example.com/live.m3u8" >> whitelist.txt
          echo "# 2. åŸŸåé€šé…ç¬¦: *example.com* (åŒ¹é…æ‰€æœ‰åŒ…å«example.comçš„URL)" >> whitelist.txt
          echo "# 3. å…³é”®å­—: cctv (åŒ¹é…æ‰€æœ‰åŒ…å«cctvçš„URL)" >> whitelist.txt
          echo "# 4. æ­£åˆ™è¡¨è¾¾å¼: /.*cctv.*\\.m3u8/" >> whitelist.txt
          echo "# ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> whitelist.txt
          echo "# é…ç½®æ–‡ä»¶: config.txt" >> whitelist.txt
          echo "" >> whitelist.txt
          echo "# ç¤ºä¾‹ç™½åå•æ¡ç›®:" >> whitelist.txt
          echo "# *cctv.com*" >> whitelist.txt
          echo "# https://example.com/important-stream.m3u8" >> whitelist.txt
          echo "# /.*4k.*\\.m3u8/" >> whitelist.txt
          echo "" >> whitelist.txt
          echo "âœ… åˆ›å»ºäº†whitelist.txtç™½åå•æ–‡ä»¶"
        fi

    - name: Check config.txt content
      run: |
        echo "ğŸ“„ æ£€æŸ¥config.txté…ç½®:"
        echo "========================================"
        if [ -f config.txt ]; then
          cat config.txt
          echo "========================================"
        else
          echo "âŒ config.txtæ–‡ä»¶ä¸å­˜åœ¨"
        fi

    - name: Check sources.txt content
      run: |
        echo "ğŸ“„ æ£€æŸ¥sources.txtå†…å®¹:"
        echo "========================================"
        if [ -f sources.txt ]; then
          source_count=$(grep -c '^https://' sources.txt)
          echo "æ‰¾åˆ° $source_count ä¸ªç›´æ’­æºURL"
          if [ $source_count -eq 0 ]; then
            echo "âš ï¸  è­¦å‘Š: sources.txtä¸­æ²¡æœ‰æ‰¾åˆ°ç›´æ’­æºURL"
            echo "è¯·ç¼–è¾‘sources.txtæ–‡ä»¶æ·»åŠ ç›´æ’­æº"
          fi
        else
          echo "âŒ sources.txtæ–‡ä»¶ä¸å­˜åœ¨"
        fi

    - name: Check blacklist.txt content
      run: |
        echo "ğŸ“„ æ£€æŸ¥blacklist.txtå†…å®¹:"
        echo "========================================"
        if [ -f blacklist.txt ]; then
          blacklist_count=$(grep -c '^http' blacklist.txt)
          echo "é»‘åå•ä¸­æœ‰ $blacklist_count ä¸ªæ…¢é€Ÿæº"
        else
          echo "blacklist.txtæ–‡ä»¶ä¸å­˜åœ¨"
        fi

    - name: Check whitelist.txt content
      run: |
        echo "ğŸ“„ æ£€æŸ¥whitelist.txtå†…å®¹:"
        echo "========================================"
        if [ -f whitelist.txt ]; then
          whitelist_count=$(grep -v '^#' whitelist.txt | grep -c '.')
          echo "ç™½åå•ä¸­æœ‰ $whitelist_count ä¸ªæ¡ç›®"
          if [ $whitelist_count -gt 0 ]; then
            echo "ç™½åå•å†…å®¹:"
            grep -v '^#' whitelist.txt | head -20
          fi
        else
          echo "whitelist.txtæ–‡ä»¶ä¸å­˜åœ¨"
        fi

    - name: Run collection script
      id: collect
      run: |
        echo "ğŸš€ å¼€å§‹è¿è¡Œé‡‡é›†è„šæœ¬..."
        python scripts/collect_sources.py
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æ–‡ä»¶
        if [ -f live_sources.m3u ]; then
          echo "âœ… æ£€æµ‹åˆ°ç”Ÿæˆäº†live_sources.m3uæ–‡ä»¶"
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "CHANGED=true" >> $GITHUB_ENV
        else
          echo "âŒ æœªç”Ÿæˆlive_sources.m3uæ–‡ä»¶"
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "CHANGED=false" >> $GITHUB_ENV
        fi

    - name: Show generated files
      run: |
        echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la *.m3u *.json *.txt 2>/dev/null || echo "ä¸»æ–‡ä»¶æœªæ‰¾åˆ°"
        echo ""
        echo "ğŸ“ categoriesç›®å½•:"
        ls -la categories/*.m3u 2>/dev/null | head -20 || echo "categoriesç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
        echo ""
        echo "ğŸ“ mergedç›®å½•:"
        ls -la merged/*.m3u 2>/dev/null | head -20 || echo "mergedç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"

    - name: Check file contents
      run: |
        echo "ğŸ“„ æ£€æŸ¥æ–‡ä»¶å†…å®¹:"
        if [ -f live_sources.m3u ]; then
          echo "live_sources.m3u é¢‘é“æ•°é‡: $(grep -c '^#EXTINF' live_sources.m3u || echo 0)"
          echo ""
          echo "å¤šæºç»Ÿè®¡:"
          multi_source_count=$(grep -c '\[[0-9]\+æº\]' live_sources.m3u || echo 0)
          echo "å¤šæºç”µè§†å°: $multi_source_count ä¸ª"
          
          # æ£€æŸ¥ç™½åå•æ ‡è®°
          whitelist_count=$(grep -c 'tvg-whitelist="true"' live_sources.m3u || echo 0)
          if [ $whitelist_count -gt 0 ]; then
            echo "ç™½åå•é¢‘é“: $whitelist_count ä¸ª"
          fi
        fi
        
        if [ -f blacklist.txt ]; then
          echo ""
          echo "blacklist.txt ç»Ÿè®¡:"
          blacklist_count=$(grep -c '^http' blacklist.txt)
          echo "é»‘åå•æ¡ç›®: $blacklist_count ä¸ª"
        fi
        
        if [ -f whitelist.txt ]; then
          echo ""
          echo "whitelist.txt ç»Ÿè®¡:"
          whitelist_count=$(grep -v '^#' whitelist.txt | grep -c '.')
          echo "ç™½åå•æ¡ç›®: $whitelist_count ä¸ª"
        fi

    - name: Commit and push if changed
      if: env.CHANGED == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.LIVEIPTV }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add -A
        git commit -m "ğŸ“º æ›´æ–°ç›´æ’­æº $(date '+%Y-%m-%d %H:%M:%S')
        
        - è‡ªåŠ¨åˆå¹¶åŒåç”µè§†å°
        - æ”¯æŒå¤šæºåˆ‡æ¢åŠŸèƒ½
        - é¢‘é“åç§°ç²¾ç®€å¤„ç†
        - æŒ‰çœä»½åˆ†ç±»åœ°æ–¹å°
        - æ–°å¢æ™¯åŒºé¢‘é“åˆ†ç±»
        - IPv6æºä¼˜å…ˆæ’åº
        - é»‘ç™½åå•è¿‡æ»¤ç³»ç»Ÿ
        - æ–°å¢ç™½åå•ä¿æŠ¤é‡è¦æº
        "
        
        # ä½¿ç”¨GITHUB_TOKENæ¨é€
        git push

    - name: Show success message
      if: env.CHANGED == 'true'
      run: |
        echo "ğŸ‰ ç›´æ’­æºæ›´æ–°æˆåŠŸï¼"
        echo ""
        echo "âš™ï¸  é…ç½®çŠ¶æ€:"
        echo "- é»‘åå•åŠŸèƒ½: $(grep 'ENABLE_BLACKLIST=' config.txt | cut -d= -f2 || echo 'true')"
        echo "- ç™½åå•åŠŸèƒ½: $(grep 'ENABLE_WHITELIST=' config.txt | cut -d= -f2 || echo 'true')"
        echo "- æµ‹é€ŸåŠŸèƒ½: $(grep 'ENABLE_SPEED_TEST=' config.txt | cut -d= -f2 || echo 'false')"
        echo ""
        echo "ğŸ“º ç”Ÿæˆçš„æ–‡ä»¶:"
        echo "- live_sources.m3u (IPv6ä¼˜å…ˆå¤šæºåˆå¹¶ç‰ˆ - PotPlayer/VLCä½¿ç”¨)"
        echo "- merged/å¤šæºåˆ†ç¦»ç‰ˆ.m3u (TiviMate/Kodiä½¿ç”¨)"
        echo "- merged/ç²¾ç®€ç‰ˆ.m3u (å•æºç²¾ç®€ç‰ˆ)"
        echo "- channels.json (è¯¦ç»†æ•°æ®)"
        echo "- categories/*.m3u (åˆ†ç±»åˆ—è¡¨)"
        echo "- blacklist.txt (æ…¢é€Ÿæºé»‘åå•)"
        echo "- whitelist.txt (é‡è¦æºç™½åå•)"
        echo "- config.txt (é…ç½®æ–‡ä»¶)"
        echo ""
        echo "ğŸ”— è®¿é—®åœ°å€:"
        echo "https://github.com/${{ github.repository }}/blob/main/live_sources.m3u"
        echo ""
        echo "ğŸ“Š æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡:"
        echo "https://github.com/${{ github.repository }}/blob/main/channels.json"
        echo ""
        echo "ğŸ® æ’­æ”¾å™¨ä½¿ç”¨æç¤º:"
        echo "1. PotPlayer/VLC: ä½¿ç”¨live_sources.m3uï¼Œæ’­æ”¾æ—¶æŒ‰Alt+Wåˆ‡æ¢æº"
        echo "2. TiviMate/Kodi: ä½¿ç”¨merged/å¤šæºåˆ†ç¦»ç‰ˆ.m3uï¼Œè‡ªåŠ¨åˆå¹¶ç›¸åŒåç§°é¢‘é“"
        echo "3. å…¶ä»–æ’­æ”¾å™¨: ä½¿ç”¨merged/ç²¾ç®€ç‰ˆ.m3uï¼Œæ¯ä¸ªç”µè§†å°IPv6æºä¼˜å…ˆ"
        echo ""
        echo "âš¡ è¿‡æ»¤è§„åˆ™:"
        echo "- ç™½åå•ä¼˜å…ˆçº§é«˜äºé»‘åå•ï¼ˆå¯é…ç½®ï¼‰"
        echo "- ç™½åå•å¯å¿½ç•¥é€Ÿåº¦æµ‹è¯•ï¼ˆå¯é…ç½®ï¼‰"
        echo "- é»‘åå•: blacklist.txt"
        echo "- ç™½åå•: whitelist.txt"
        echo "- é…ç½®: config.txt"

    - name: Show failure message
      if: env.CHANGED == 'false'
      run: |
        echo "âŒ ç›´æ’­æºæ›´æ–°å¤±è´¥"
        echo "è¯·æ£€æŸ¥:"
        echo "1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
        echo "2. æºåœ°å€æ˜¯å¦å¯ä»¥è®¿é—®"
        echo "3. sources.txtä¸­æ˜¯å¦æœ‰æœ‰æ•ˆçš„ç›´æ’­æºURL"
        echo "4. Pythonè„šæœ¬æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯"
        echo "5. é…ç½®æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®"
        echo ""
        echo "ğŸ“‹ è°ƒè¯•ä¿¡æ¯:"
        echo "æŸ¥çœ‹ä¸Šæ–¹Run collection scriptæ­¥éª¤çš„è¾“å‡º"