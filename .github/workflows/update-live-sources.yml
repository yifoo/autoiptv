name: Update Live TV Sources

on:
  schedule:
    - cron: '0 18 * * *'  # æ¯å¤©UTC 18:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ï¼‰
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'sources.txt'
      - '.github/workflows/update-live-sources.yml'
      - 'scripts/collect_sources.py'

permissions:
  contents: write

jobs:
  collect-and-organize:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Create necessary directories
      run: |
        mkdir -p scripts
        mkdir -p categories
        mkdir -p merged

    - name: Check Python script
      run: |
        if [ -f scripts/collect_sources.py ]; then
          echo "âœ… Pythonè„šæœ¬å·²å­˜åœ¨"
          echo "ğŸ“„ è„šæœ¬å†…å®¹å¤§å°: $(wc -l scripts/collect_sources.py | cut -d' ' -f1) è¡Œ"
        else
          echo "âŒ Pythonè„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi

    - name: Create sources.txt if not exists
      run: |
        if [ ! -f sources.txt ]; then
          echo "# ç”µè§†ç›´æ’­æºåˆ—è¡¨" > sources.txt
          echo "# æ¯è¡Œä¸€ä¸ªM3Uæ–‡ä»¶URL" >> sources.txt
          echo "" >> sources.txt
          echo "âœ… åˆ›å»ºäº†sources.txtæ–‡ä»¶"
        fi

    - name: Run collection script
      id: collect
      run: |
        echo "ğŸš€ å¼€å§‹è¿è¡Œé‡‡é›†è„šæœ¬..."
        python scripts/collect_sources.py
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æ–‡ä»¶
        if [ -f live_sources.m3u ]; then
          echo "âœ… æ£€æµ‹åˆ°ç”Ÿæˆäº†live_sources.m3uæ–‡ä»¶"
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "CHANGED=true" >> $GITHUB_ENV
        else
          echo "âŒ æœªç”Ÿæˆlive_sources.m3uæ–‡ä»¶"
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "CHANGED=false" >> $GITHUB_ENV
        fi

    - name: Show generated files
      run: |
        echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la *.m3u *.json *.html *.md 2>/dev/null || echo "ä¸»æ–‡ä»¶æœªæ‰¾åˆ°"
        echo ""
        echo "ğŸ“ categoriesç›®å½•:"
        ls -la categories/*.m3u 2>/dev/null | head -10 || echo "categoriesç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
        echo ""
        echo "ğŸ“ mergedç›®å½•:"
        ls -la merged/*.m3u 2>/dev/null | head -10 || echo "mergedç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"

    - name: Check file contents
      run: |
        echo "ğŸ“„ æ£€æŸ¥æ–‡ä»¶å†…å®¹:"
        if [ -f live_sources.m3u ]; then
          echo "live_sources.m3u å‰5è¡Œ:"
          head -5 live_sources.m3u
          echo ""
          echo "live_sources.m3u é¢‘é“æ•°é‡: $(grep -c '^#EXTINF' live_sources.m3u || echo 0)"
        fi
        
        if [ -f channels.json ]; then
          echo "channels.json æ–‡ä»¶å¤§å°: $(wc -c channels.json | cut -d' ' -f1) bytes"
        fi

    - name: Commit and push if changed
      if: env.CHANGED == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add -A
        git commit -m "ğŸ“º æ›´æ–°ç›´æ’­æº $(date '+%Y-%m-%d %H:%M:%S')
        
        - è‡ªåŠ¨åˆå¹¶åŒåç”µè§†å°
        - æ”¯æŒæºåˆ‡æ¢åŠŸèƒ½
        - é¢‘é“åç§°ç²¾ç®€å¤„ç†
        "
        
        # ä½¿ç”¨GITHUB_TOKENæ¨é€
        git push

    - name: Show success message
      if: env.CHANGED == 'true'
      run: |
        echo "ğŸ‰ ç›´æ’­æºæ›´æ–°æˆåŠŸï¼"
        echo ""
        echo "ğŸ”— è®¿é—®åœ°å€:"
        echo "https://github.com/${{ github.repository }}/blob/main/live_sources.m3u"
        echo "https://${{ github.repository_owner }}.github.io/$(echo ${{ github.repository }} | cut -d/ -f2)/"
        echo ""
        echo "ğŸ“Š æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡:"
        echo "https://github.com/${{ github.repository }}/blob/main/channels.json"

    - name: Show failure message
      if: env.CHANGED == 'false'
      run: |
        echo "âŒ ç›´æ’­æºæ›´æ–°å¤±è´¥"
        echo "è¯·æ£€æŸ¥:"
        echo "1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
        echo "2. æºåœ°å€æ˜¯å¦å¯ä»¥è®¿é—®"
        echo "3. Pythonè„šæœ¬æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯"
        echo ""
        echo "ğŸ“‹ è°ƒè¯•ä¿¡æ¯:"
        echo "æŸ¥çœ‹ä¸Šæ–¹Run collection scriptæ­¥éª¤çš„è¾“å‡º"