name: Update Live TV Sources

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: 
      - 'sources.txt'
      - '.github/workflows/update-live-sources.yml'
      - 'scripts/collect_sources.py'

jobs:
  collect-and-organize:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.LIVEIPTV }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Create directories
      run: |
        mkdir -p scripts
        mkdir -p categories

    - name: Create requirements file
      run: echo "requests>=2.31.0" > scripts/requirements.txt

    - name: Run collection script
      id: collect
      run: |
        cd scripts
        python collect_sources.py
        
        if [ -f ../live_sources.m3u ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "CHANGED=true" >> $GITHUB_ENV
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "CHANGED=false" >> $GITHUB_ENV
        fi

    - name: Check generated files
      run: |
        echo "=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ ==="
        ls -la *.m3u *.json *.html *.md 2>/dev/null || echo "æœªæ‰¾åˆ°ä¸»æ–‡ä»¶"
        ls -la categories/*.m3u 2>/dev/null | head -5 || echo "æœªæ‰¾åˆ°åˆ†ç±»æ–‡ä»¶"

    - name: Commit and push changes
      if: env.CHANGED == 'true'
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        git add -A
        git commit -m "ğŸ“º æ›´æ–°ç›´æ’­æº $(date '+%Y-%m-%d %H:%M:%S')" || echo "æ²¡æœ‰å˜æ›´å¯æäº¤"
        
        # å°è¯•æ¨é€
        git push https://x-access-token:${{ secrets.LIVEIPTV }}@github.com/${{ github.repository }}.git main

    - name: Show success message
      if: env.CHANGED == 'true'
      run: |
        echo "âœ… ç›´æ’­æºæ›´æ–°æˆåŠŸï¼"
        echo ""
        echo "ğŸ”— è®¿é—®åœ°å€:"
        echo "https://github.com/${{ github.repository }}/blob/main/live_sources.m3u"
        echo "https://${{ github.repository_owner }}.github.io/$(echo ${{ github.repository }} | cut -d/ -f2)/"

    - name: Show failure message
      if: env.CHANGED == 'false'
      run: |
        echo "âŒ ç›´æ’­æºæ›´æ–°å¤±è´¥"
        echo "è¯·æ£€æŸ¥è„šæœ¬æ‰§è¡Œæ—¥å¿—"