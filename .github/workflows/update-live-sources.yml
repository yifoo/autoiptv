name: Update Live TV Sources

on:
  schedule:
    - cron: '0 18 * * *'  # æ¯å¤©UTC 18:00è¿è¡Œ
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'sources.txt'
      - '.github/workflows/update-live-sources.yml'
      - 'scripts/collect_sources.py'

permissions:
  contents: write

jobs:
  collect-and-organize:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Create necessary directories
      run: |
        mkdir -p scripts
        mkdir -p categories

    - name: Check if Python script exists
      run: |
        if [ -f scripts/collect_sources.py ]; then
          echo "âœ… Pythonè„šæœ¬å·²å­˜åœ¨"
        else
          echo "âŒ Pythonè„šæœ¬ä¸å­˜åœ¨ï¼Œè¯·ç¡®ä¿scripts/collect_sources.pyå·²æäº¤"
          exit 1
        fi

    - name: Create sources.txt if not exists
      run: |
        if [ ! -f sources.txt ]; then
          echo "# ç”µè§†ç›´æ’­æºåˆ—è¡¨" > sources.txt
          echo "# æ¯è¡Œä¸€ä¸ªM3Uæ–‡ä»¶URL" >> sources.txt
          echo "" >> sources.txt
          echo "https://raw.githubusercontent.com/fanmingming/live/main/tv/m3u/ipv6.m3u" >> sources.txt
          echo "https://raw.githubusercontent.com/chao921125/source/refs/heads/main/iptv/index.m3u" >> sources.txt
          echo "âœ… åˆ›å»ºäº†sources.txtæ–‡ä»¶"
        fi

    - name: Run collection script
      id: collect
      run: |
        echo "ğŸš€ å¼€å§‹è¿è¡Œé‡‡é›†è„šæœ¬..."
        python scripts/collect_sources.py
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æ–‡ä»¶
        if [ -f live_sources.m3u ]; then
          echo "âœ… æ£€æµ‹åˆ°ç”Ÿæˆäº†live_sources.m3uæ–‡ä»¶"
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "CHANGED=true" >> $GITHUB_ENV
        else
          echo "âŒ æœªç”Ÿæˆlive_sources.m3uæ–‡ä»¶"
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "CHANGED=false" >> $GITHUB_ENV
        fi

    - name: List generated files
      run: |
        echo "ğŸ“ å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo ""
        echo "ğŸ“ categoriesç›®å½•:"
        ls -la categories/ 2>/dev/null || echo "categoriesç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "ğŸ“ scriptsç›®å½•:"
        ls -la scripts/

    - name: Commit and push if changed
      if: env.CHANGED == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add -A
        git commit -m "ğŸ“º æ›´æ–°ç›´æ’­æº $(date '+%Y-%m-%d %H:%M:%S')"
        
        # ä½¿ç”¨GITHUB_TOKENæ¨é€
        git push